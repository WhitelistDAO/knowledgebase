## 零知识证明初学

#### 背景

1989 年，由麻省理工学院研究人员 Goldwasser、Micali 及 Rackoff 提出了「零知识证明」的概念。2009年1月3日，比特币网络发行了最初的50个比特币，从此，一个新的时代开始了。随着比特币币值的一路飙升，比特币受到了越来越多的关注，比特币系统中的一些缺陷也获得了越来越多的关注与讨论。缺乏隐私保护是比特币系统的主要缺陷之一，比特币网络中的所有交易以明文的方式记录在区块链上。虽然比特币系统使用的是与身份无关的地址，通过追踪货币在地址之间的流动，依然可以分析出来哪些地址属于同一个用户。为了解决比特币的隐私保护问题，一系列的解决方案被提出。其中2015年提出的 Zerocash使用了一种特殊类型的零知识证明工具 zk-SNARKs 实现了对交易金额与交易方的完全隐藏。2017 年，Zerocash 团队提出了将 zk-SNARKs 与智能合约结合的方案，使零知识证明 zk-SNARKs 获得了更高的关注度。

#### 概念

通过zk-SNIPM讲述的一个故事来理解零知识证明的概念

Alice、Bob 和 Charlie 都是数独爱好者，所谓数独是这样一种游戏，玩家需要根据 9×9 盘面上的已知数字，推理出所有剩余空格的数字，并满足每一行、每一列、每一个粗线宫（3x3）的数字均含 1 到 9，且不重复。

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjFlNjkxMTA4MjU1ZmYwYzY3NzNiYjU3NWNmZDNjYjhfanNBMWVBOHE1ZlpNNnp6bWxtd2JjNW9xd0VKOExHQWlfVG9rZW46Ym94Y251eENGZzVHSDFINUlwTDlHcmFGWUpXXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

有一天 Alice 设计了一道巨难的数独题目来考 Bob 和 Charlie，Bob 苦思冥想了几天也做不出，便向 Alice 抱怨这肯定是道无解的题目。Alice 不想将实际的解告诉 Bob，但是又需要证明她确实知道解，于是她设计了一种巧妙的「零知识证明」的方式。

- 证明（The Proof )

Alice 拿出 81 （9x9）张空白的卡片，并在每张纸上写上 1-9 中的一个数字，接着她将代表谜面的卡片数字面朝上、代表谜底的卡片数字面朝下都放在桌上，并组成了 9x9 的矩阵。

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDY3MThkODU0ZThiNDYxZDVjOWQzYmRkNGY0NTkzMzZfZWh0RzBnOGp2c3R5MjRNR0ZMNXluRmdPWjZGcG91QWdfVG9rZW46Ym94Y25ETFpRdFFTQXE1NkZmUUVZMTN1SFFkXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

- 随机挑战（The Random Challenge）

接下来怎么让 Bob 确认这就是正确的解呢？很简单，由 Bob 随机选择行、列或是粗线宫中的一种进行验证，假如选择行，则将这 81 张卡片按 9 行分别放到 9 个麻布袋中，摇匀并确保卡片次序打乱。

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=NjBjNGI3YTQzYmYxYWM0MGUyYjAwYWM0NWRiN2ZhMDdfQTlSOG00WEVNQ2N0VU1nYkxDVmlJQ3pycXhlNGpJbE9fVG9rZW46Ym94Y255OWQ0VENMUUsyTW9pdkx0OTV6Z3diXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

- 验证（The Verify）

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=OGJiZTJjZmNlNmQ2YWQ2NGJiZDU3ZGNlY2UwMThmZGVfRDdFWHZvN2Q2MlIwQzhWOGxUTXh0Z2l6VnIwZklnaEJfVG9rZW46Ym94Y253TG1TcURHUDdTNzltUlNUR1ZkSlRjXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

- 简洁（Succinct）

虽然数独游戏有 3 种情况需要验证（行、列、粗线宫），但每次验证时 Bob 实际只需要验证其中的一种，这有效减少了验证工作量，提供给验证者的实际是一个比原命题小的多的证明，这就是所谓的简洁。

- 重复（Repeat）

之后重复这个随机验证步骤，我们假设 Alice 运气很好，每次都能提前猜中 Bob 会选择哪种验证方式，并以此来模拟一个解，那么她通过 1 次验证的概率为 1/3，通过 2 次验证的概率为 1/9，通过 10 次验证概率就只有 1/59049 了。在不厌其烦的进行了 20 次验证之后，Bob 无奈的承认，Alice 是真的知道这个答案的解，因为 Alice 凭运气通过验证的概率只有 35 亿分之一！（这也是为何我们说零知识证明是在概率上成立的证明）

- 模拟（The Simulation）

这个时候，Charlie 也来向 Alice 抱怨这个题目的无解，Alice 和 Bob 又重复了刚才的证明，没想到却没有得到 Charlie 的认可。Charlie 提出了这个证明中的漏洞，如果 Bob 和 Alice 是一伙的，每次 Bob 都会提前告诉 Alice 他要选择的验证方式，那么 Alice 就可以很容易的在没有解的情况下模拟出一个证明来通过这些测试。

- 非交互式证明（Non-Interactive Proofs）

不可能让每个持有这种怀疑的人都重复一遍 Bob 进行的随机验证，于是三个小伙伴设计了一台神奇的机器，Alice 只需要提交一次卡片，这台机器就可以按照初始设置好的验证序列，自动化的对这些卡片进行重复验证。验证从交互式的，变成了非交互式的。这里我们要注意，并不是说非交互式证明就没有重复随机实验这个过程。实际上，只不过是随机点不由验证者给出，而是由一个可信的第三方在初始化阶段就给出，这样一来，证明者就可以直接给出证明，验证者只需要验证证明即可，验证者和证明者之间不再需要交互。

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=NDdhNzgxYmEzM2QzOTM2OGRiNWM3MjNjMGI4NTA2ODJfZXZJNFZPUm1uOGdyeEhYMGVMSE5JN3J4SmRJY2k5UWZfVG9rZW46Ym94Y253OUJHenpJbk42WUVLVUhYRHZBOWJjXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

- 可信设置仪式（Trusted Setup Ceremony）

其中最有趣也最重要的环节就是验证序列的初始设置。在机器启动前，会有一排设置旋钮，通过这些旋钮可以选定每一轮的验证方式。在设置这些旋钮时，每个人依次进入放置机器的房间，选择一个旋钮并设置好，之后就用一个铁盒子彻底焊死这个旋钮，让其他人无法看见也无法改变这个旋钮的选择。为了让初始设置尽可能的可信，小伙伴们邀请了镇长、小学校长和警察局长这三位小镇上最德高望重的长者来参加设置仪式，大家都相信他们绝对不可能参与作假，因此他们称之为「可信任的初始设置仪式」。

![img](https://z374q654zv.feishu.cn/space/api/box/stream/download/asynccode/?code=NTZlYjcyNDkwZWY0NTgyNTcxYjE4YzdkODg4ZTdmMzZfaGZTc2xENFEyaGQwV1NxaHNGQmlCVjF3UllsajM1c3NfVG9rZW46Ym94Y25HQ0Fab05SWXFoQUpoeExFTGdCVzhmXzE2NzU0MTUzMTM6MTY3NTQxODkxM19WNA)

一台数独游戏的简洁非交互式零知识证明机，诞生了！

#### 一些理解

零知识证明的本质就是在不揭晓我所知道或拥有的某样东西的前提下，向别人证明我有很大几率确实知道或拥有这个东西。

故事里要证明的东西就是一个数独题的解，小明让小红每次随机抽取行，列，九宫格的卡片，并收集在一起随机打乱，小红通过拆开袋子并不能知道题解，但是却能相信小明很大几率确实知道题解。

这个故事里的zk-SNIPM也是半开玩笑地暗指了零知识证明现在最普遍的zk-SNARKs算法。故事中的zk-SNIPM虽然存在漏洞，但是他还有改进的余地，比如用一台扫描仪把第一次卡片的组合就全扫描下来，然后一次性同时验证所有的试验序列。这样就很难通过试错的方式来破解机器。

小明和小红之间最开始那种互动式的证明方法暗指的是交互式零知识证明（interactive zero-knowledge proof）。交互式零知识证明需要验证方（小红）在证明方（小明）放好答案（commitment）后，不断的发送随机试验。如果验证和证明双方事先串通好，那么他们就可以在不知道真实答案的情况下开挂（simulate/forge a proof）。

非交互式的证明则不需要这种互动。但是会额外需要一些机器或者程序，并且需要一串试验序列，这个试验序列不能被任何人知道。有了这么一个程序和试验序列，证明机就能自动算出一个证明，并且能防止任何一方作假。